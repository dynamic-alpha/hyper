# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ main ]
    tags: [ 'v[0-9]+.[0-9]+.[0-9]+' ]
  pull_request:
    branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  test-clj:
    name: Test Clojure
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Enable Nix cache
        # uses: DeterminateSystems/magic-nix-cache-action@v11
        uses: Camsbury/magic-nix-cache-action@main
        with:
          use-github-fork: true
          github-fork-repo: Camsbury/magic-nix-cache
          github-fork-ref: latest
          github-fork-asset: magic-nix-cache
          use-flakehub: false

      - name: Cache clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
          # List all files containing dependencies:
          key: cljdeps-${{ hashFiles('deps.edn') }}
          restore-keys: cljdeps-

      - name: Build (nix-shell)
        run: nix-shell --run "echo \"finished building.\""
      - name: Lint (clj-kondo)
        run: nix-shell --run "clj-kondo --lint src"
      - name: Format Check (cljfmt)
        run: nix-shell --run "cljfmt check"
      - name: Run Tests
        run: nix-shell --run "clojure -M:main:test"
